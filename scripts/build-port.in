#!/usr/bin/env bash
#  SPDX-License-Identifier: LGPL-2.1-or-later

print_help()
{
	echo "usage: $COLLECTION [option]"
	echo "options:"
	echo "   -a,   --all                 will build all the ports of the '$COLLECTION' collection in the right order"
	echo "  -cb,   --check-binaries      check if binaries are uptodate"
	echo "   -d,   --dry                 check if binaries are different then the ports but dont build anything"
	echo "   -h,   --help                print help and exit"
	echo "   -v,   --version             print version and exit"
}
check_binaries()
{
	local name file
	if [ ! -d ${BINARY_BASE} ]; then
		echo "The directory ${BINARY_BASE} doesn't exist"
		exit 1
	fi
	for name in $(ls ${BINARY_BASE}|cut -d "." -f1|uniq)
	do
		if [ ! -d $COLLECTION/$name ]; then
			echo "'$name' packages should be removed and delete from the .REPO file"
			for file in $(ls $name.*)
			do
				rm -v $file
			done
			sed -i "/^@$name.*/,/^$/d" $PKGMK_REPO_FILE
		fi
	done
	cd - > /dev/null
}
parse_options() {
	if [ $# -lt 1 ]; then
		print_help
		exit 0
	fi
	while [ "$1" ]; do
		case $1 in
			-a|--all)
				check_binaries
				build_binaries
				exit 0
				;;
			-cb|--check-binaries)
				check_binaries
				exit 0
				;;
			-d|--dry)
				DRY="yes"
				check_binaries
				build_binaries
				exit 0
				;;
			-h|--help)
				print_help
				exit 0;;

			-v|--version)
				echo "$COLLECTION $BUILD_PORT_VERSION"
                exit 0 ;;

			*)
				if [ ! -d "$COLLECTION/$1" ]; then
					echo "I dont know the port $1"
					exit 1
				fi
				;;

		esac
		shift
	done
}
get_port_version() {
	local port base_port PORTS_DIR tmprel
	port=$COLLECTION/$package
	PORTS_DIR=$COLLECTION
	base_port=$(echo $package | cut -d "-" -f1)
	unset version
	release=1
	. $port/Pkgfile
	[ ! -z $release ] && tmprel=$release
	if [ -z $version ] && [ "$base_port" != "$package" ] ; then
		if [ -f $PORTS_DIR/$base_port/Pkgfile ]; then
			cd $PORTS_DIR/$base_port
			. Pkgfile
			cd - > /dev/null
		fi
	fi
	[ ! -z $tmprel ] && release=$tmprel
	port_version="$version-$release"
}
build_binaries () {
	local package
	if [ -n "$(cards level|grep WARNING|head -1)" ]; then
		cards level
		exit 1;
	fi
	for package in $(cards level | grep " $COLLECTION/"|cut -d "/" -f2)
	do
		if [  -z "$(ls ${BINARY_BASE}/$package*.cards-* 2>/dev/null )" ];then
			cd $GIT
			[ "$DRY" == "yes" ] && continue
			bash scripts/$COLLECTION $package || exit 1
			continue
		fi
		get_port_version
		binary_version=$(cards info -v $package)
		if [ "$port_version" != "${binary_version}" ]; then
			echo "$package: Port: $port_version, Binary: $binary_version"
			cd $GIT
			[ "$DRY" == "yes" ] && continue
			bash scripts/$COLLECTION $package || exit 1
			continue
		fi
		[ "$DRY" == "yes" ] || echo "WILL NOT BUILD '$package' AGAIN.."
	done
}
main() {
	if [ ! -d .git ] && [ ! -d scripts ]; then
		echo "Make shure you are at the root of the git"
		echo "Your are in: $GIT"
		exit 1
	fi
	if [ "$UID" == "0" ] && [ -O scripts ] ; then
		echo "your are 'root' account
Means you are not suppose to 'git pull' this git project"
		echo "I quit for now

"
		exit 1
	fi
	if [ ! -d "$COLLECTION" ]; then
		echo "I dont know the collection $COLLECTION"
		exit 1
	fi
	parse_options "$@"
	cards create -r $1
}
PKGMK_REPO_FILE=.REPO
BUILD_PORT_VERSION=#VERSION#
DRY="no"
ARCH=$(uname -m)
COLLECTION="$(basename $0)"
GIT="$PWD"
PROJECT="$(basename $GIT)"
BINARY_BASE=/DEPOT/$COLLECTION
main "$@"
