#!/bin/bash
#
#  cards
# 
#  Copyright (c) 2014 by NuTyX team (http://nutyx.org)


#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, 
#  USA.
#

##

readonly CARDS_VERSION="#VERSION#"

CONFIG_FILE="/etc/pkgdwl.conf"

info() {
   echo "=======> $1"
}
error() {
   info "ERROR: $1" >&2
}
warning() {
   info "WARNING: $1" >&2
}
usage() {
   echo 1>&2 'USAGE:

 cards sync 
 cards -S
 cards --synchronise

  to synchronise the local information with the depot server. At the moment it just sync the folders
'
  echo 1>&2 " cards $CARDS_VERSION"
  echo 1>&2 ""
  exit 0
}
if [ "$UID" != "0" ]; then
   error "Only root can check"
   exit 1
fi

if [ $# -eq 0 -o $# -gt 1 ]; then
   usage
fi

if [ ! -f $CONFIG_FILE ]; then
   error "$CONFIG_FILE not found"
   exit 1
fi

warning "Still VERY experimental"

DEPOT_URL=`cat $CONFIG_FILE|grep url|cut -d "=" -f2|sed "s/ //g"`

if [ "$DEPOT_URL" == "" ]; then
   error "Variable url missing in $CONFIG_FILE"
   exit 1
fi

DEPOT_DIR=`cat $CONFIG_FILE|grep dir|cut -d "=" -f2|sed "s/ //g"`

if [ "$DEPOT_DIR" == "" ]; then
   error "Variable dir missing in $CONFIG_FILE"
   exit 1
fi

DEPOT_VERSION=`curl -s -K $CONFIG_FILE |grep -o "<a href=\"[[:print:]]\+\/\""|cut -d "\"" -f2|sort -n|tail -1`
DEPOT_DIRECTORIES=`curl -s ${DEPOT_URL}/$DEPOT_VERSION |grep -o "<a href=\"[^/][[:print:]]\+\/\""|cut -d "\"" -f2|sort -n`

if [ "$1" == "sync" ] || [ "$1" == "-S" ] || [ "$1" == "--synchronise" ]; then 
  if [ ! -d $DEPOT_DIR/$DEPOT_VERSION ]; then
	mkdir -vp ${DEPOT_DIR}/${DEPOT_VERSION}
  fi
  for LOCAL_DIR in $DEPOT_DIRECTORIES
  do
    rm -rf ${DEPOT_DIR}/${DEPOT_VERSION}${LOCAL_DIR}
    for i in `curl -s $DEPOT_URL/$DEPOT_VERSION/$LOCAL_DIR/|grep -o "<a href=\"[a-z][[:print:]]\+\/\""|cut -d "\"" -f2`
    do
      PORT_DIR=`echo $i|sed "s/%23/#/"|sed "s|/$||"`
      PORT_NAME=`echo $dir|cut -d "_" -f1`
      mkdir -vp ${DEPOT_DIR}/${DEPOT_VERSION}${LOCAL_DIR}${PORT_DIR}
    done
  done
else
 usage
fi
